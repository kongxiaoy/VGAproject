# 双人坦克大战 - 操作手册

## 游戏简介

两名玩家各控制一辆坦克，通过发射子弹击败对方。每人3条命，先击败对方者获胜。

---

## 硬件连接

```
┌─────────────┐    USB线    ┌─────────────┐    VGA线   ┌─────────┐
│   笔记本    │ ─────────> │ Nexys4 DDR  │ ────────> │  显示器  │
│   电脑      │            │   (FPGA)    │           │         │
└─────────────┘            └─────────────┘           └─────────┘
```

- **USB线**：连接电脑和开发板（与烧写用的是同一根线）
- **VGA线**：连接开发板和显示器

---

## 使用步骤

### 第一步：安装 Python 依赖

打开命令行（CMD 或 PowerShell），运行：

```bash
pip install pyserial pynput
```

### 第二步：烧写 FPGA

1. 打开 Vivado
2. 生成 Bitstream
3. Program Device 烧写到开发板

### 第三步：运行控制程序

```bash
cd tank_game/software
python tank_controller.py
```

### 第四步：选择串口

程序会列出所有可用串口：

```
可用的串口:
  0: COM6 - 蓝牙链接上的标准串行 (COM6)
  1: COM4 - 蓝牙链接上的标准串行 (COM4)
  2: COM3 - 蓝牙链接上的标准串行 (COM3)
  3: COM5 - 蓝牙链接上的标准串行 (COM5)
  4: COM7 - USB Serial Port (COM7)

请输入串口编号:
```

**选择 "USB Serial Port" 对应的编号**（上例中输入 `4`）

### 第五步：开始游戏

连接成功后显示：

```
已连接到 COM7
开始游戏！按 ESC 退出
```

现在可以用键盘控制坦克了！

---

## 控制方式

### 玩家1（绿色坦克）

| 操作 | 按键 |
|------|------|
| 上移 | W |
| 下移 | S |
| 左移 | A |
| 右移 | D |
| 开火 | J |

### 玩家2（蓝色坦克）

| 操作 | 按键 |
|------|------|
| 上移 | I |
| 下移 | K |
| 左移 | H |
| 右移 | L |
| 开火 | N |

### 其他

| 操作 | 按键 |
|------|------|
| 退出程序 | ESC |
| 重新开始 | 按开发板 RESET 按钮 |

---

## 游戏规则

1. 每位玩家初始 **3 条命**（屏幕顶部红色方块显示）
2. 被对方子弹击中 **减 1 条命**
3. 生命归零则 **游戏结束**
4. **砖墙**（棕色）可以被子弹摧毁
5. **铁墙**（灰色）不可摧毁
6. 每位玩家同时最多 **2 颗子弹** 在场

---

## 常见问题

### Q: 找不到串口？

**A:** 
- 检查 USB 线是否连接好
- 尝试重新插拔 USB 线
- 检查设备管理器中是否有 "USB Serial Port"

### Q: 选择串口后无反应？

**A:** 
- 确认选择了 "USB Serial Port"，不是蓝牙串口
- 确认 FPGA 已经烧写成功
- 查看开发板 LED 是否亮起（显示按键状态）

### Q: 权限错误？

**A:** 
- Windows：以管理员身份运行命令行
- Linux/Mac：使用 `sudo python tank_controller.py`

### Q: LED 亮但游戏画面不动？

**A:** 
- 检查 VGA 线连接
- 确认显示器输入源选择正确

### Q: 按键延迟很大？

**A:** 
- 关闭其他占用 CPU 的程序
- 确认波特率设置正确（115200）

---

## 项目文件结构

```
tank_game/
├── README.md                    # 本文档
├── constraint/
│   └── tank_game.xdc           # 引脚约束文件
├── software/
│   └── tank_controller.py      # 电脑端控制程序
└── src/
    ├── top/
    │   └── tank_game_top.v     # 顶层模块
    ├── input/
    │   ├── uart_rx.v           # 串口接收
    │   └── uart_key_decoder.v  # 按键解码
    ├── vga/
    │   ├── DST.v               # 显示时序
    │   ├── game_ddp.v          # 像素坐标
    │   └── renderer.v          # 画面渲染
    └── game/
        ├── game_ctrl.v         # 游戏主控
        ├── tank.v              # 坦克模块
        ├── bullet.v            # 子弹模块
        ├── collision.v         # 碰撞检测
        └── map.v               # 地图模块
```

---

## Vivado 项目创建

1. 创建新项目，器件选择 `xc7a100tcsg324-1`
2. 添加 `src/` 下所有 `.v` 文件
3. 添加 `constraint/tank_game.xdc`
4. 创建 Clocking Wizard IP 核：
   - 名称：`clk_wiz_0`
   - 输入：100 MHz
   - 输出：50 MHz
5. 综合 → 实现 → 生成 Bitstream → 烧写

---

## 技术参数

| 参数 | 值 |
|------|-----|
| 显示分辨率 | 800×600 @ 72Hz |
| 游戏分辨率 | 200×150（4倍放大）|
| 串口波特率 | 115200 |
| 系统时钟 | 100 MHz |
| 像素时钟 | 50 MHz |

---

祝游戏愉快！🎮

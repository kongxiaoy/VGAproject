# VGA 显示控制器项目详解

## 📋 项目概述

本项目是一个基于 **FPGA** 的 **VGA 显示控制器**，实现了从简单的白屏显示到静态图片展示，再到多帧视频播放的渐进式功能。项目采用模块化设计，具有良好的可扩展性和复用性。

### 项目特点

- **分辨率**：800×600 @ 72Hz
- **像素时钟**：50MHz（由 100MHz 系统时钟分频）
- **色彩深度**：12位 RGB（每通道4位）
- **图像缩放**：支持 4× 放大（200×150 → 800×600）
- **视频播放**：支持多帧动画循环播放

---

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                         顶层模块 (Top Module)                         │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐           │
│  │  clk_wiz_0   │    │     DST      │    │     DDP      │           │
│  │  (时钟生成)   │───▶│  (时序控制)   │───▶│  (数据处理)   │           │
│  └──────────────┘    └──────────────┘    └──────────────┘           │
│         │                   │                   │                    │
│    100MHz→50MHz        hs/vs/hen/ven      rgb/raddr                 │
│                                                 │                    │
│                              ┌──────────────────┴───────────────┐   │
│                              │      blk_mem_gen (VRAM)          │   │
│                              │        (图像/视频存储)             │   │
│                              └──────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
                              ┌──────────────┐
                              │   VGA 显示器  │
                              │  (800×600)   │
                              └──────────────┘
```

---

## 📁 文件结构

| 文件名 | 功能描述 | 代码行数 |
|--------|----------|----------|
| `DST.v` | 显示扫描定时模块 (Display Scan Timing) | 138 |
| `DDP.v` | 显示数据处理模块 (Display Data Processing) | 63 |
| `PS.v` | 脉冲/边沿检测模块 (Pulse/Edge Detect) | 21 |
| `vga_white_top.v` | 白屏显示顶层模块 | 43 |
| `vga_image_top.v` | 静态图片显示顶层模块 | 67 |
| `vga_video_top.v` | 视频播放顶层模块 | 142 |

---

## 🔧 核心模块详解

### 1. DST 模块 (Display Scan Timing)

**功能**：生成 VGA 显示所需的同步信号和有效区域标志。

#### VGA 时序参数 (800×600 @ 72Hz)

```
水平时序 (Horizontal Timing):
┌────────┬────────┬────────────────────┬────────┐
│  HSW   │  HBP   │        HEN         │  HFP   │
│  120   │   64   │        800         │   56   │  = 1040 像素/行
└────────┴────────┴────────────────────┴────────┘

垂直时序 (Vertical Timing):
┌────────┬────────┬────────────────────┬────────┐
│  VSW   │  VBP   │        VEN         │  VFP   │
│   6    │   23   │        600         │   37   │  = 666 行/帧
└────────┴────────┴────────────────────┴────────┘
```

#### 状态机设计

```verilog
// 四状态循环
localparam SW = 2'b00;  // 同步脉冲 (Sync Width)
localparam BP = 2'b01;  // 后沿消隐 (Back Porch)
localparam EN = 2'b10;  // 有效显示 (Enable)
localparam FP = 2'b11;  // 前沿消隐 (Front Porch)
```

#### 信号输出

| 信号 | 描述 |
|------|------|
| `hs` | 行同步信号，SW 阶段为高 |
| `vs` | 场同步信号，SW 阶段为高 |
| `hen` | 水平有效，EN 阶段为高 |
| `ven` | 垂直有效，EN 阶段为高 |

#### 内部计数器模块 (CntS)

```verilog
module CntS #(
    parameter WIDTH   = 16,
    parameter RST_VLU = 0
)(
    input  clk, rstn, ce,
    input  [WIDTH-1:0] d,     // 置数值
    output reg [WIDTH-1:0] q  // 当前计数
);
```

- **工作原理**：倒计数器，计数到 0 后重新加载 `d` 值
- **特点**：参数化设计，可配置位宽和复位值

---

### 2. DDP 模块 (Display Data Processing)

**功能**：实现画布与显示屏的适配，处理图像放大和地址计算。

#### 核心功能：4× 图像放大

```
原始图像 (200×150)          放大后显示 (800×600)
┌─────────────────┐         ┌─────────────────────────────┐
│  ●              │   ──▶   │  ■■■■                       │
│  (1个像素)       │         │  ■■■■  (4×4 个像素)          │
│                 │         │  ■■■■                       │
│                 │         │  ■■■■                       │
└─────────────────┘         └─────────────────────────────┘
```

#### 地址计算逻辑

```verilog
reg [1:0] sx, sy;  // 4×4 放大计数器

always @(posedge pclk) begin
    if(hen && ven) begin
        rgb <= rdata;
        if(sx == 2'b11)         // 每4个像素
            raddr <= raddr + 1; // 地址递增
        nsx <= sx + 1;
    end
    else if(p) begin            // 行结束时
        if(sy != 2'b11)         // 每4行
            raddr <= raddr - H_LEN;  // 回退一行
        else if(raddr == H_LEN * V_LEN)
            raddr <= 0;         // 帧结束，重置
        nsy <= sy + 1;
    end
end
```

#### 参数配置

| 参数 | 默认值 | 描述 |
|------|--------|------|
| `DW` | 15 | 地址位宽 (支持 32768 像素) |
| `H_LEN` | 200 | 原始图像宽度 |
| `V_LEN` | 150 | 原始图像高度 |

---

### 3. PS 模块 (Pulse/Edge Detect)

**功能**：边沿检测，用于捕获信号的上升沿或下降沿。

```verilog
// 实现原理
reg s_delay;

always @(posedge clk)
    s_delay <= s;

assign p = s & ~s_delay;  // 检测上升沿
```

**波形图**：

```
s:        ──┐     ┌───────────
            │     │
            └─────┘

s_delay:  ────┐     ┌─────────
              │     │
              └─────┘

p:        ────┐ ┌─────────────
              │ │  (1个周期脉冲)
              └─┘
```

---

## 🎨 顶层模块设计

### 题目 3-1：白屏显示 (vga_white_top)

**功能**：在有效显示区域输出纯白色。

```verilog
// 简单的组合逻辑
assign red   = (hen & ven) ? 4'hF : 4'h0;
assign green = (hen & ven) ? 4'hF : 4'h0;
assign blue  = (hen & ven) ? 4'hF : 4'h0;
```

**数据流**：

```
clk(100MHz) ──▶ clk_wiz_0 ──▶ pclk(50MHz)
                              │
                              ▼
                            DST ──▶ hen, ven, hs, vs
                              │
                              ▼
                    (hen & ven) ? 白色 : 黑色 ──▶ VGA输出
```

---

### 题目 3-2：静态图片显示 (vga_image_top)

**功能**：从 VRAM 读取图像数据并显示。

**系统架构**：

```
                    ┌─────────────┐
    pclk ──────────▶│     DST     │──▶ hen, ven, hs, vs
                    └─────────────┘
                           │
                           ▼
                    ┌─────────────┐     ┌─────────────┐
    rdata ◀────────│     DDP     │◀───│   VRAM      │
                    │             │────▶│ (ROM IP核)  │
                    └─────────────┘     └─────────────┘
                           │               raddr
                           ▼
                    RGB[11:0] ──▶ VGA输出
```

**VRAM 配置**：
- 类型：Single Port ROM
- 容量：32768 × 12 bit
- 存储：200×150 = 30000 像素
- 数据格式：RGB444（R[11:8], G[7:4], B[3:0]）

---

### 题目 3-3：视频播放 (vga_video_top)

**功能**：循环播放多帧图像实现动画效果。

#### 参数配置

```verilog
parameter FRAME_COUNT = 5;          // 总帧数
parameter FRAME_SIZE  = 30000;      // 每帧像素数 (200×150)
parameter FRAMES_PER_IMAGE = 4;     // 每帧显示的场数 (72Hz/4 ≈ 18fps)
```

#### 帧切换逻辑

```verilog
always @(posedge pclk) begin
    if (vs_falling) begin  // 场同步下降沿
        if (vsync_cnt >= FRAMES_PER_IMAGE - 1) begin
            vsync_cnt <= 0;
            if (frame_idx >= FRAME_COUNT - 1) begin
                // 循环回第一帧
                frame_idx <= 0;
                frame_base_addr <= 0;
            end
            else begin
                // 切换到下一帧
                frame_idx <= frame_idx + 1;
                frame_base_addr <= frame_base_addr + 30000;
            end
        end
        else
            vsync_cnt <= vsync_cnt + 1;
    end
end
```

#### 地址计算

```verilog
// 18位地址 = 帧基地址 + 帧内偏移
wire [17:0] vram_addr = frame_base_addr + {3'b000, frame_addr};
```

**VRAM 内存布局**：

```
地址范围          │ 内容
──────────────────┼──────────
0x00000 - 0x07530 │ 帧 0 (Frame 0)
0x07530 - 0x0EA60 │ 帧 1 (Frame 1)
0x0EA60 - 0x15F90 │ 帧 2 (Frame 2)
0x15F90 - 0x1D4C0 │ 帧 3 (Frame 3)
0x1D4C0 - 0x249F0 │ 帧 4 (Frame 4)
```

---

## ⏱️ 时序分析

### VGA 时序关键参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 像素时钟 | 50 MHz | 20ns/像素 |
| 行频 | 48.08 kHz | 1040 × 20ns ≈ 20.8μs |
| 场频 | 72 Hz | 666 × 20.8μs ≈ 13.9ms |
| 有效像素/帧 | 480,000 | 800 × 600 |

### 数据流时序

```
像素时钟周期 N:
├── raddr 更新
├── VRAM 访问 (1周期延迟)
└── rdata 有效

像素时钟周期 N+1:
├── rgb 输出
└── VGA DAC 采样
```

---

## 🔌 外部 IP 核依赖

| IP 核 | 功能 | 配置 |
|-------|------|------|
| `clk_wiz_0` | 时钟管理 | 100MHz → 50MHz |
| `blk_mem_gen_0` | 图像 ROM | 32K × 12bit |
| `blk_mem_gen_4` | 视频 ROM | 256K × 12bit (18位地址) |

---

## 📊 资源估计

### 逻辑资源

| 模块 | 寄存器 | LUT | 说明 |
|------|--------|-----|------|
| DST | ~50 | ~80 | 计数器+状态机 |
| DDP | ~40 | ~60 | 地址计算 |
| PS | ~2 | ~2 | 边沿检测 |
| 顶层 | ~20 | ~30 | 帧控制 (视频版) |

### 存储资源

| 配置 | BRAM (36Kb) | 说明 |
|------|-------------|------|
| 单帧图像 | 1 | 30000 × 12bit |
| 5帧视频 | 5 | 150000 × 12bit |
| 8帧视频 | 8 | 240000 × 12bit |

---

## 🚀 使用指南

### 1. 准备图像数据

将图像转换为 COE 文件格式：

```
memory_initialization_radix=16;
memory_initialization_vector=
FFF,    // 像素 0: 白色
F00,    // 像素 1: 红色
0F0,    // 像素 2: 绿色
00F,    // 像素 3: 蓝色
...
```

### 2. 配置 IP 核

**Clocking Wizard**:
- 输入频率：100 MHz
- 输出频率：50 MHz

**Block Memory Generator**:
- 类型：Single Port ROM
- 位宽：12
- 深度：根据需求（图像 32768，视频 262144）
- 初始化：加载 COE 文件

### 3. 引脚约束 (XDC 示例)

```tcl
# 时钟
set_property PACKAGE_PIN W5 [get_ports clk]
set_property IOSTANDARD LVCMOS33 [get_ports clk]

# VGA 输出
set_property PACKAGE_PIN G19 [get_ports {red[0]}]
set_property PACKAGE_PIN H19 [get_ports {red[1]}]
# ... 其他引脚
```

---

## 📝 设计要点总结

1. **模块化设计**：DST、DDP、PS 模块高度解耦，便于复用和测试

2. **参数化实现**：通过参数配置适应不同分辨率和帧数

3. **时序同步**：使用边沿检测确保帧切换的准确性

4. **资源优化**：4× 放大减少 16 倍存储需求

5. **流水线设计**：地址计算与数据读取并行，提高吞吐量

---

## 🔗 扩展建议

- **分辨率支持**：修改 DST 参数支持 640×480、1024×768 等
- **色彩深度**：扩展至 RGB565 或 RGB888
- **双缓冲**：添加帧缓冲避免画面撕裂
- **图像处理**：增加亮度/对比度调节模块
- **接口扩展**：添加 HDMI/DVI 编码器

---

*文档版本: 1.0*  
*最后更新: 2025年*

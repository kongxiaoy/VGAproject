# FPGA 吃豆人 - 开发摘要

## 项目概述

基于 Xilinx FPGA (xc7a100t) 的经典吃豆人游戏，通过 UART 接收 PC 键盘输入，VGA 输出 200×150 分辨率画面（4倍放大到800×600）。

---

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      pacman_top                             │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────┐    ┌─────────────────┐    ┌───────────────┐  │
│  │ clk_wiz  │    │    uart_rx      │    │  DST (VGA时序)│  │
│  │100→50MHz │    │   115200baud    │    │  800x600@72Hz │  │
│  └──────────┘    └────────┬────────┘    └───────────────┘  │
│                           │                                 │
│                  ┌────────▼────────┐                       │
│                  │  pacman_input   │                       │
│                  │   按键解码      │                       │
│                  └────────┬────────┘                       │
│                           │                                 │
│  ┌────────────────────────▼─────────────────────────────┐  │
│  │                   pacman_game                         │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐              │  │
│  │  │ 玩家控制 │  │ 幽灵AI×2│  │  maze   │              │  │
│  │  │ 移动检测 │  │ 追踪移动 │  │ 豆子状态 │              │  │
│  │  └─────────┘  └─────────┘  └─────────┘              │  │
│  │                      │                               │  │
│  │              ┌───────▼───────┐                      │  │
│  │              │    渲染输出    │                      │  │
│  │              └───────────────┘                      │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## 模块详解

### 1. pacman_top.v - 顶层模块
- 实例化时钟 IP、UART、VGA 时序、游戏主控
- 连接各模块信号
- LED 调试输出

### 2. pacman_input.v - 按键解码
- 接收 UART 数据，解码为游戏控制信号
- 小写字母 = 按下，大写字母 = 松开

| 按键 | 发送字符 | 功能 |
|------|---------|------|
| W | w/W | 上 |
| S | s/S | 下 |
| A | a/A | 左 |
| D | d/D | 右 |
| R | r/R | 复位 |

### 3. pacman_game.v - 游戏主控
核心模块，包含：
- 游戏状态机 (READY → PLAY → WIN/LOSE)
- 玩家移动控制
- 幽灵 AI
- 碰撞检测
- 渲染输出

### 4. maze.v - 迷宫模块
- 20×15 格子迷宫布局
- 豆子状态位图管理
- 渲染墙壁和豆子
- 统计剩余豆子数量

---

## 核心算法

### 格子坐标系统

```
像素坐标 → 格子坐标:
  cell_x = (pixel_x + SIZE/2) / CELL_SIZE
  cell_y = (pixel_y + SIZE/2) / CELL_SIZE

格子内偏移:
  offset_x = (pixel_x + SIZE/2) % CELL_SIZE
  offset_y = (pixel_y + SIZE/2) % CELL_SIZE

格子中心判断 (可转向):
  at_center = (offset_x >= 4 && offset_x <= 5) &&
              (offset_y >= 4 && offset_y <= 5)
```

### 移动逻辑

```verilog
// 只有在对齐时才能向该方向移动
// 例如：向上移动需要 X 轴对齐格子中心
case (player_dir)
    DIR_UP: begin
        if (player_at_center_x) begin  // X 轴对齐
            if (player_can_up || player_offset_y > 5)  // 前方无墙 或 还没到边界
                player_y <= player_y - PLAYER_SPEED;
        end
    end
    // ...
endcase
```

### 幽灵追踪 AI

```verilog
// 在格子中心选择方向
if (ghost_at_center) begin
    // 1. 优先：朝玩家方向（不能掉头）
    if (want_up && can_up && dir != DOWN) dir <= UP;
    else if (want_down && can_down && dir != UP) dir <= DOWN;
    // ...
    
    // 2. 次选：任意可行方向（不掉头）
    else if (can_up && dir != DOWN) dir <= UP;
    // ...
    
    // 3. 死胡同：掉头
    else if (can_up) dir <= UP;
    // ...
end
```

---

## 遇到的问题及解决方案

### 问题1: 玩家穿墙

**原因分析：**
- 原设计使用状态机进行碰撞检测，每次移动需要多个 tick
- maze 模块输出是寄存器，有一周期延迟
- 状态机与 maze 输出时序不匹配

**解决方案：**
- 用 `function is_wall()` 内联墙壁判断，纯组合逻辑无延迟
- 简化移动逻辑，每个 tick 直接判断并移动
- 移动条件：`can_move || offset > 5`（前方无墙 或 还没到格子边界）

### 问题2: 幽灵不追人，直线移动

**原因分析：**
- 幽灵只在 `at_center` 时检查方向
- 原设计幽灵移动时不检查墙壁，直接穿墙
- 方向选择逻辑依赖 maze 模块查询，有时序问题

**解决方案：**
- 同样使用 `function is_wall()` 内联判断
- 幽灵移动前检查：`can_move || offset > 5`
- 确保幽灵在格子中心正确选择追踪方向

### 问题3: 转向不灵活

**原因分析：**
- 只有精确在格子中心才能转向
- 格子中心判断范围太小

**解决方案：**
- 格子中心判断范围：offset 在 4-5 之间（2像素宽度）
- 预输入方向：按下方向键立即记录，到达格子中心时转向

---

## 迷宫布局

```
####################   Row 0:  全墙边框
#........##........#   Row 1:  上部通道
#.##.###.##.###.##.#   Row 2:  
#..................#   Row 3:  开阔区
#.##.###..###.##.#.#   Row 4:  
#....#......#....#.#   Row 5:  
####.#.####.#.#.###    Row 6:  
#....#......#....#.#   Row 7:  中部通道
#.##.#.####.#.##.##.#   Row 8:  
#....#......#....#.#   Row 9:  
#.####.###.###.##.#    Row 10: 
#.........#........#   Row 11: 玩家初始位置
#.##.##.#.##.##.##.#   Row 12: 
#..................#   Row 13: 开阔区
####################   Row 14: 全墙边框
```

- `#` = 墙壁 (蓝色)
- `.` = 豆子 (白色)
- 玩家初始：格子 (10, 11)
- 幽灵1初始：格子 (1, 1) 红色
- 幽灵2初始：格子 (18, 1) 粉色

---

## 文件结构

```
pacman/
├── README.md                 # 使用说明
├── DEVELOPMENT_SUMMARY.md    # 本文档
├── pacman.xdc                # 引脚约束
├── pacman_controller.py      # PC端控制程序
├── pacman_top.v              # 顶层模块
├── pacman_game.v             # 游戏主控 [核心]
├── pacman_input.v            # 按键解码
├── maze.v                    # 迷宫和豆子
├── uart_rx.v                 # 串口接收 (复用)
├── DST.v                     # VGA时序 (复用)
└── game_ddp.v                # 像素坐标 (复用)
```

---

## 关键数值参考

| 参数 | 值 | 说明 |
|------|-----|------|
| 游戏分辨率 | 200×150 | 逻辑像素 |
| VGA 分辨率 | 800×600 | 4倍放大 |
| 刷新率 | 72Hz | VGA 输出 |
| 游戏 tick | 30Hz | 逻辑更新 |
| 格子大小 | 10×10 | 像素 |
| 迷宫尺寸 | 20×15 | 格子 |
| 玩家/幽灵大小 | 5×5 | 像素 |
| 豆子大小 | 2×2 | 像素 |
| 移动速度 | 1 | 像素/tick |

---

## 代码统计

| 文件 | 行数 | 说明 |
|------|------|------|
| pacman_game.v | ~420 | 游戏核心逻辑 |
| maze.v | 165 | 迷宫+豆子 |
| pacman_input.v | 48 | 按键解码 |
| pacman_top.v | 136 | 顶层模块 |
| **核心代码合计** | **~770** | 符合预估 |

---

## 可扩展方向

### 1. 大力丸
- 添加 4 个大力丸位置
- 吃到后幽灵变蓝，可反杀
- 持续时间计时器

### 2. 多条命
- 初始 3 条命
- 被抓后重生
- 显示剩余生命

### 3. 计分系统
- 普通豆子 10 分
- 大力丸 50 分
- 吃幽灵 200/400/800/1600 分
- 七段数码管显示

### 4. 传送通道
- 左右边界互通
- 经典吃豆人特性

### 5. 更多幽灵
- 4 个幽灵
- 不同性格 AI（追踪/埋伏/随机/胆小）

---

## 版本历史

| 版本 | 更新内容 |
|------|----------|
| v1.0 | 基础框架，迷宫渲染，玩家移动 |
| v1.1 | 添加幽灵，碰撞检测 |
| v1.2 | **修复穿墙 bug**，内联墙壁判断函数 |
| v1.2 | **修复幽灵 AI**，正确追踪玩家 |

---

## 调试建议

1. **LED 显示按键状态**：确认 UART 通信正常
2. **固定幽灵位置**：先调试玩家移动
3. **注释掉碰撞检测**：单独测试移动逻辑
4. **放大格子尺寸**：便于观察坐标计算

---

祝开发顺利！🎮
